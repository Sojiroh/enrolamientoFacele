/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

package my.enrolamiento;

import beans.ContribuyenteBean;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JFileChooser;
import static my.enrolamiento.enrolamientoFaceleUI.logger;

/**
 *
 * @author Jorge
 */
public class propiedades extends javax.swing.JFrame {
    ContribuyenteBean cBean;

    /**
     * Creates new form propiedades
     */
    public propiedades() {
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        fileChooser = new javax.swing.JFileChooser();
        jButton1 = new javax.swing.JButton();
        btn_cerrar = new javax.swing.JButton();

        fileChooser.setCurrentDirectory(new java.io.File("C:\\Users\\Jorge\\Dropbox"));

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);

        jButton1.setText("jButton1");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        btn_cerrar.setText("Cerrar");
        btn_cerrar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btn_cerrarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(23, 23, 23)
                .addComponent(btn_cerrar)
                .addGap(28, 28, 28)
                .addComponent(jButton1)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btn_cerrar)
                    .addComponent(jButton1))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        // TODO add your handling code here:
        int returnVal = fileChooser.showOpenDialog(this);
        if (returnVal == JFileChooser.APPROVE_OPTION) {
        File file = fileChooser.getSelectedFile();
            try {
                cBean = getBean(file);
                System.out.println(cBean.getCasaMatriz());
            } catch (Exception ex) {
                Logger.getLogger(propiedades.class.getName()).log(Level.SEVERE, null, ex);
            }
        FileWriter fichero = null;
        PrintWriter pw = null;
        try
        {
                fichero = new FileWriter(file.getParent()+"/properties.xml");
                pw = new PrintWriter(fichero);
                pw.println("<?xml version=\"1.0\" encoding=\"UTF-8\"?>");
                pw.println("<!DOCTYPE properties SYSTEM \"http://java.sun.com/dtd/properties.dtd\">");
                pw.println("<properties>");
                pw.println("<comment/>");
                pw.println("<entry key=\"EMISOR.ACTECO\">"+cBean.getActeco().get(0)+";</entry>");
                pw.println("<entry key=\"EMISOR.CIUDAD\">"+cBean.getCasaMatriz().getProperty("CIUDAD")+"</entry>");
                pw.println("<entry key=\"EMISOR.COMUNA\">"+cBean.getCasaMatriz().getProperty("COMUNA")+"</entry>");
                pw.println("<entry key=\"EMISOR.DIRECCION\">"+cBean.getCasaMatriz().getProperty("DIRECCION")+"</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE110\">0</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE111\">0</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE112\">0</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE33\">0</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE34\">0</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE43\">0</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE46\">0</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE52\">0</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE56\">0</entry>");
                pw.println("<entry key=\"EMISOR.FOLIO.DTE61\">0</entry>");
                pw.println("<entry key=\"EMISOR.GIRO\">"+cBean.getGiro()+"</entry>");
                pw.println("<entry key=\"EMISOR.RAZONSOCIAL\">"+cBean.getRazonSocial()+"</entry>");
                pw.println("<entry key=\"EMISOR.RUT\">"+cBean.getRutContribuyente()+"</entry>");
                pw.println("<entry key=\"PAHT.TXT.OUT\">C:\\Users\\Jorge Arriagada\\Dropbox\\ENROLAMIENTO\\CONTRIBUYENTES\\ACTIVAS\\76081507-1_textil jadue\\1</entry>");
                pw.println("<entry key=\"RECEPTOR.CIUDAD\">SANTIAGO</entry>");
                pw.println("<entry key=\"RECEPTOR.COMUNA\">LAS CONDES</entry>");
                pw.println("<entry key=\"RECEPTOR.DIRECCION\">JOSE DE MORALEDA 4568</entry>");
                pw.println("<entry key=\"RECEPTOR.GIRO\">ASESORIA E IMPLEMENTACION DE SISTEMAS DE FACTURACION</entry>");
                pw.println("<entry key=\"RECEPTOR.RAZONSOCIAL\">FACTURA ELECTRONICA INTREGARACION S.A.</entry>");
                pw.println("<entry key=\"RECEPTOR.RUT\">76001565-2</entry>");
                pw.println("</properties>");
 
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
           try {
           // Nuevamente aprovechamos el finally para 
           // asegurarnos que se cierra el fichero.
           if (null != fichero)
              fichero.close();
           } catch (Exception e2) {
              e2.printStackTrace();
           }
        }
        
        
        
    } else {
        System.out.println("File access cancelled by user.");
    }
    }//GEN-LAST:event_jButton1ActionPerformed

    
    public static ContribuyenteBean getBean(File contribuyente) throws Exception {
		logger.debug("...Start");
		ContribuyenteBean bean = new ContribuyenteBean();
		BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(contribuyente), "ISO-8859-1"));
		String line ="";
		while ((line = reader.readLine()) != null) {
			if (line.trim().isEmpty())
				continue;
			logger.debug("Linea: " + line);
			if (line.contains(":")) {
				logger.debug("Es un key: " + line);
				if (line.contains("Rut Contribuyente")) {
					bean.setRutContribuyente(reader.readLine().trim());				
				} else if (line.contains("Nombre o Razón Social")) {
					bean.setRazonSocial(reader.readLine().trim());
				} else if (line.contains("Dirección de la Empresa")) {
					bean.setCasaMatriz(getCasaMatriz(reader.readLine()));
				} else if (line.contains("Actividades Económicas")) {
					bean.setActeco(getActecos(reader));
				} else if (line.contains("Glosa Descriptiva")) {
					bean.setGiro(reader.readLine().trim());
				} else {
					logger.info("KEY no definido en lógica de bean: " + line);
				}
			}
		}
		reader.close();
		return bean;
	}
    
    private String cortarGiro(String giro){
		String retorna = giro;
			if(giro.length()>36){
				retorna = giro.substring(0,36) + "...";
			}
		return giro;
	}
    
    private static List<Integer> getActecos(BufferedReader reader) throws Exception {
		List<Integer> retorna = new ArrayList<>();
		String line;
		while (true) {
			line = reader.readLine();
			if (line.trim().isEmpty())
				break;
			try {
				int acteco = Integer.parseInt(line.split(";")[0]);
				retorna.add(acteco);
			} catch (Exception e) {
				logger.debug("No es un entero por lo que no es una actividad economica: " +  e.getMessage());
			}
		}
		return retorna;
	}

	private static Properties getCasaMatriz(String line) {
		Properties retorna = new Properties();	
		boolean comunaFlag = false;
		boolean ciudadFlag = false;
		
		if (line.contains("Comuna")) comunaFlag = true;
		if (line.contains("Ciudad")) ciudadFlag = true;
		
		int n = 0;
		for (String elemento : line.split(",")) {
			n++;
			if (n == 1)	{	//Dirección de casa matriz
				String direccion = elemento.trim();			
				// TODO se debe hacer algunos tratamientos a este contenido.
				retorna.setProperty("DIRECCION", direccion);
			} else {
				if (elemento.contains("Comuna")) {
					String comuna = elemento.replace("Comuna", "").trim();
					retorna.setProperty("COMUNA", comuna);
					
					if (!ciudadFlag)
						retorna.setProperty("CIUDAD", comuna);
				} else if (elemento.contains("Ciudad")) {
					String ciudad = elemento.replace("Ciudad", "").trim();
					retorna.setProperty("CIUDAD", ciudad);
					
					if (!comunaFlag)
						retorna.setProperty("COMUNA", ciudad);
				}
			}
		}
		return retorna;
	}
    
    private void btn_cerrarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btn_cerrarActionPerformed
        // TODO add your handling code here:
        dispose();
    }//GEN-LAST:event_btn_cerrarActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(propiedades.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(propiedades.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(propiedades.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(propiedades.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new propiedades().setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btn_cerrar;
    private javax.swing.JFileChooser fileChooser;
    private javax.swing.JButton jButton1;
    // End of variables declaration//GEN-END:variables
}
